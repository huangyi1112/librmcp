=========
Messaging
=========

some of my notes on the rmcp protocol

protocol notes
==============
1. Some systems may not generate RMCP ACKs even if requested. Software should be designed to handle this occurrence.
2. RMCP and ASF-specified fields are therefore transferred most-significant byte first.
3. Data in the IPMI Session Header and IPMI Message fields are transmitted least-significant byte first.


RMCP Message Format
===================

rmcp message format
-------------------

+------------------+---------------+------------------------+
| field            | size in bytes | 06h = RMCP version 1.0 |
+------------------+---------------+------------------------+
| Version          | 1             | 06h = RMCP Version 1.0 |
+------------------+---------------+------------------------+
| Reserved         | 1             | 00h                    |
+------------------+---------------+------------------------+
| Sequence Number  | 1             | varies, see text       |
+------------------+---------------+------------------------+
| class of message | 1             | see class table        |
+------------------+---------------+------------------------+
| data             | variable      | self explanitory*      |
+------------------+---------------+------------------------+
  * with the notable execption that I don't see length defined anywhere

class of message
^^^^^^^^^^^^^^^^

+-----+-----------+---------------------+
| bit | value     | description         |
+-----+-----------+---------------------+
| 7   |           |                     |
+-----+-----------+---------------------+
|     | 0         | Normal RMCP message |
+-----+-----------+---------------------+
|     | 1         | RMCP Ack            |
+-----+-----------+---------------------+
| 6:5 | N/A       | Reserved            |
+-----+-----------+---------------------+
| 4:0 |           | Message Class       |
+-----+-----------+---------------------+
|     | 0-5       | reserved            |
+-----+-----------+---------------------+
|     | 6         | ASF                 |
+-----+-----------+---------------------+
|     | 7         | IPMI                |
+-----+-----------+---------------------+
|     | 8         | OEM defined         |
+-----+-----------+---------------------+
|     | remaining | reserved            |
+-----+-----------+---------------------+



message type determination under RMCP
-------------------------------------


+----------------+---------------+------------------------+---------------------------------------------+
| ack/Normal bit | Message class | message type           | message data                                |
+----------------+---------------+------------------------+---------------------------------------------+
| ack            | asf           | rmcp ack               | RMCP header with the sequence number*       |
+----------------+---------------+------------------------+---------------------------------------------+
| ack            | all other     | undefined              | not allowed                                 |
+----------------+---------------+------------------------+---------------------------------------------+
| normal         | asf           | asf messaged           | per asf specification                       |
+----------------+---------------+------------------------+---------------------------------------------+
| normal         | oem           | oem message under RMCP | bytes 0:3 = OEM IANA / bytes 0:4 = OEM data |
+----------------+---------------+------------------------+---------------------------------------------+
| normal         | ipmi          | ipmi messages          | per this spec                               |
+----------------+---------------+------------------------+---------------------------------------------+
 * sequence number is set to the sequence number from the last message that was recieved, no data


ASF/RMCP Messages for IPMI-over-LAN
-----------------------------------


+-------------------+-------------+
| message           | description |
+-------------------+-------------+
| RMCP ack          | recommended |
+-------------------+-------------+
| asf presence ping | required    |
+-------------------+-------------+
| asf presence pong | required    |
+-------------------+-------------+

RMCP ack message
----------------

+------------------+-------------------------------------------------------------+
| field            | value                                                       |
+------------------+-------------------------------------------------------------+
| version          | copied from received message                                |
+------------------+-------------------------------------------------------------+
| reserved         | copied from received message                                |
+------------------+-------------------------------------------------------------+
| sequence number  | coped from received message                                 |
+------------------+-------------------------------------------------------------+
| class of message | 7 - set to one == 'ack' 6:0 == copied from received message |
+------------------+-------------------------------------------------------------+
| rmcp data        | none                                                        |
+------------------+-------------------------------------------------------------+


RMCP ping
---------


+----------------+------------------------+---------------+-------------------------------------------+
| protocol notes | field                  | size in bytes | value                                     |
+----------------+------------------------+---------------+-------------------------------------------+
| udp header     | source port            | 2             | per udp                                   |
+----------------+------------------------+---------------+-------------------------------------------+
|                | dest port              | 2             | 26Fh                                      |
+----------------+------------------------+---------------+-------------------------------------------+
|                | udp length             | 2             | per udp                                   |
+----------------+------------------------+---------------+-------------------------------------------+
|                | udp checksum           | 2             | per udp                                   |
+----------------+------------------------+---------------+-------------------------------------------+
| rmcp header    | version                | 1             | 06h - RMCP Version 1.0                    |
+----------------+------------------------+---------------+-------------------------------------------+
|                | rmcp seq               | 1             | 0-254 if 'ack' is desired, 255 for no ack |
+----------------+------------------------+---------------+-------------------------------------------+
|                | class of message       | 1             | 06 for ASF                                |
+----------------+------------------------+---------------+-------------------------------------------+
| asf message    | iana enterprise number | 4             | 4542 (ASF IANA)                           |
+----------------+------------------------+---------------+-------------------------------------------+
|                | msg type               | 1             | 80h == presence ping                      |
+----------------+------------------------+---------------+-------------------------------------------+
|                | msg tag                | 1             | 0-FEh == req/resp, 255 == unidirectional  |
+----------------+------------------------+---------------+-------------------------------------------+
|                | reserved               | 1             | 00h                                       |
+----------------+------------------------+---------------+-------------------------------------------+
|                | data length            | 1             | 00h                                       |
+----------------+------------------------+---------------+-------------------------------------------+

RMCP pong
---------


+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
| protocol notes | field                  | size in bytes | value                                                                         |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
| udp header     | source port            | 2             | 26Fh                                                                          |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | dest port              | 2             | from ping request                                                             |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | udp length             | 2             | per udp                                                                       |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | udp checksum           | 2             | per udp                                                                       |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
| rmcp header    | version                | 1             | 6 == rmcp version 1.0                                                         |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | reserved               | 1             | 00h                                                                           |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | rmcp sequence num      | 1             | FFh for IPMI                                                                  |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | class of message       | 1             | 06h for ASF                                                                   |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
| asf message    | iana enterprise number | 4             | 4542 = asf iana                                                               |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | message type           | 1             | 40h presence pong                                                             |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | message tag            | 1             | from ping request                                                             |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | reserved               | 1             | 00h                                                                           |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | data length            | 1             | 16                                                                            |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | iana enterprise numner | 4             | if 4542 then no oem specific capabilities, next field blank                   |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | oem defined            | 4             | not used for ipmi                                                             |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | supported entities     | 1             | 81h for ipmi: 7 1 = ipmi supported, 6:4 reserved, 3:0 0001b = ASF version 1.0 |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+
|                | reserved               | 6             | reserved                                                                      |
+----------------+------------------------+---------------+-------------------------------------------------------------------------------+


endianness
==========


1. detect endianness on startup
2. pass data through an interface to to check/convert on send/recieve



